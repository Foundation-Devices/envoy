# SPDX-FileCopyrightText: 2025 Foundation Devices Inc.
#
# SPDX-License-Identifier: GPL-3.0-or-later

name: Auto-increment Build Number

on:
  pull_request:
    types:
      - opened

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Increment build number
        run: |
          # Extract current version line
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml)
          echo "Current: $CURRENT_VERSION"
          
          # Extract version name and build number
          VERSION_NAME=$(echo $CURRENT_VERSION | sed -E 's/version: ([0-9]+\.[0-9]+\.[0-9]+)\+([0-9]+)/\1/')
          BUILD_NUMBER=$(echo $CURRENT_VERSION | sed -E 's/version: ([0-9]+\.[0-9]+\.[0-9]+)\+([0-9]+)/\2/')
          
          # Increment build number
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          NEW_VERSION="version: ${VERSION_NAME}+${NEW_BUILD_NUMBER}"
          
          echo "New: $NEW_VERSION"
          
          # Update pubspec.yaml
          sed -i "s/^version: .*/version: ${VERSION_NAME}+${NEW_BUILD_NUMBER}/" pubspec.yaml
          
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pubspec.yaml
          git diff --staged --quiet || git commit -m "chore: bump build number [skip ci]"
          git push origin HEAD:${{ github.head_ref }}
