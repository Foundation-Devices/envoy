// SPDX-FileCopyrightText: 2022 Foundation Devices Inc.
//
// SPDX-License-Identifier: GPL-3.0-or-later

import 'package:envoy/business/server.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:http_tor/http_tor.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';

// Autogenerated
import 'server_test.mocks.dart';

@GenerateMocks([HttpTor])
void main() {
  test('Fetch firmware', () async {
    final mockHttp = MockHttpTor();

    when(mockHttp.get('https://envoy.foundation.xyz/firmware/device?id=1'))
        .thenAnswer((_) async => Response(
            202,
            '{"firmware":{"url":"https://github.com/Foundation-Devices/passport-firmware/releases/download/v1.0.8/passport-fw-1.0.8.bin","version":"v1.0.8","sha256":"6c6d1531685ac91eeea202d1fb818c4930a208a7590ab36e118bf5eb91e29e83","reproducible_hash":"ad6b4f5f4ae0b7e05ec35415713ea1ff7dde3edf10870876b1c8bd07391419d1","md5":"357cd0b9baec00de2aca0ef46ecea46f","changelog":"Mock changelog SHA256: 6c6d1531685ac91eeea202d1fb818c4930a208a7590ab36e118bf5eb91e29e83","release_date":{"secs_since_epoch":1640975208,"nanos_since_epoch":0},"device_id":1}}'
                .codeUnits));

    final fw = await Server(http: mockHttp).fetchFirmwareUpdateInfo(1);

    expect(fw, isA<FirmwareUpdate>());
    expect(fw.version, "v1.0.8");
    expect(fw.deviceId, 1);
  });

  test('Fetch Prime update chain', () async {
    final mockHttp = MockHttpTor();

    when(mockHttp
            .get('https://envoy.foundation.xyz/prime/patches?version=1.0.0'))
        .thenAnswer((_) async => Response(
            200,
            '{"patches": [{"version": "1.0.2","base_version": "1.0.0","signed_sha256": "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456","unsigned_sha256": "f6e5d4c3b2a1098765432109876543210987fedcba0987654321fedcba098765","update_filename": "firmware_v1.0.2.bin","signature_filename": "firmware_v1.0.2.bin.sig","url": "https://github.com/Foundation-Devices/KeyOS-Releases/releases/download/1.0.2/firmware_v1.0.2.bin","changelog": "","description": "Firmware update from version 1.0.0 to 1.0.2","release_date": "2025-07-30T00:00:00Z"},{"version": "1.2.0","base_version": "1.0.2","signed_sha256": "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456","unsigned_sha256": "f6e5d4c3b2a1098765432109876543210987fedcba0987654321fedcba098765","update_filename": "firmware_v1.2.0.bin","signature_filename": "firmware_v1.2.0.bin.sig","url": "https://github.com/Foundation-Devices/KeyOS-Releases/releases/download/1.2.0/firmware_v1.2.0.bin","changelog": "","description": "Firmware update from version 1.0.2 to 1.2.0","release_date": "2025-07-30T00:00:00Z"}]}'
                .codeUnits));

    final updates = await Server(http: mockHttp).fetchPrimePatches("1.0.0");

    expect(updates[0], isA<PrimePatch>());
    expect(updates[0].version, "1.0.2");
  });
}
